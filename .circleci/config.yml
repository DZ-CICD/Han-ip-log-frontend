version: 2.1

# -----------------
# 1. ORBS (도구 모음)
# -----------------
orbs:
  sonarcloud: sonarsource/sonarcloud@2.0
  slack: circleci/slack@4.12.5

# -----------------
# 2. JOBS (작업 정의)
# -----------------
jobs:
  build-scan-and-push:
    # VM 러너 사용
    machine:
      resource_class: dz-cicd/vm-runner 
    
    steps:
      # 1. 코드 가져오기
      - checkout

      # 2. 소나큐브 스캔 (sonar-project.properties 파일 필수)
      - sonarcloud/scan

      # 3. 도커 이미지 빌드 및 하버 푸시
      - run:
          name: Build and Push Frontend Image to Harbor
          command: |
            # --- [설정] 프론트엔드 정보 ---
            export IMAGE_NAME="han-ip-log-frontend"
            export HARBOR_PROJECT="haniplog"
            export HARBOR_DOMAIN="harbor.local.net"
            export IMAGE_TAG="v1.${CIRCLE_BUILD_NUM}"
            
            export FULL_IMAGE_NAME="${HARBOR_DOMAIN}/${HARBOR_PROJECT}/${IMAGE_NAME}:${IMAGE_TAG}"

            echo "Logging into Harbor..."
            # 환경변수($HARBOR_PASSWORD 등)는 CircleCI Context에서 가져옴
            echo "$HARBOR_PASSWORD" | docker login -u "$HARBOR_USER" --password-stdin $HARBOR_DOMAIN
            
            echo "Building $FULL_IMAGE_NAME..."
            docker build -t $FULL_IMAGE_NAME .
            
            echo "Pushing $FULL_IMAGE_NAME to Harbor..."
            docker push $FULL_IMAGE_NAME
      
      # 4. 슬랙 알림 (실패 시)
      - slack/notify:
          event: fail
          template: basic_fail_1
      
      # 5. 슬랙 알림 (성공 시)
      - slack/notify:
          event: pass
          template: basic_success_1

# -----------------
# 3. WORKFLOWS (실행 흐름)
# -----------------
workflows:
  frontend_workflow:
    jobs:
      - build-scan-and-push:
          # ★ 중요: 모든 비밀번호(Sonar, Harbor, Slack)가 들어있는 Context 연결
          context: 
            - cicd-secrets # (만약 slack-secrets 등 다른 이름이면 수정 필요)
          filters:
            branches:
              only:
                - main